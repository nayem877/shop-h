<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MAX | Ultra Secure v1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root{ --primary:#2ea043; --bg:#0b1118; --card:#1c2128; --text:#ffffff; --border:#30363d; --success: #2ea043; --error: #ff4444; }
        .light-mode { --bg:#f5f6f7; --card:#ffffff; --text:#1c1e21; --border:#ddd; }

        *{ box-sizing:border-box; margin:0; padding:0; font-family:'Hind Siliguri', sans-serif; }
        body{ background:var(--bg); color:var(--text); transition:.4s; overflow-x: hidden; }

        header{ display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:2px solid var(--primary); position:sticky; top:0; background:var(--bg); z-index:1000; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .logo{ font-size:24px; font-weight:700; color:var(--primary); }
        .nav-icons { display: flex; gap: 18px; align-items: center; }
        .icon-btn { cursor: pointer; font-size: 20px; color: var(--primary); transition: 0.3s; }

        .cat-wrap { display: flex; gap: 10px; padding: 15px; overflow-x: auto; scrollbar-width: none; }
        .cat-btn { background: var(--card); border: 1px solid var(--border); padding: 10px 22px; border-radius: 25px; white-space: nowrap; cursor: pointer; color: var(--text); font-size: 14px; transition: 0.3s; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #admin-panel{ display:none; padding:25px; background: rgba(46, 160, 67, 0.05); border: 2px dashed var(--primary); margin: 15px; border-radius: 25px; animation: slideDown 0.5s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .admin-input{ width:100%; padding:14px; margin-bottom:12px; border-radius:12px; border:1px solid var(--border); background: var(--card); color: var(--text); outline: none; }
        .btn-group { display: flex; gap: 10px; }
        button{ padding:12px; border:none; border-radius:12px; cursor:pointer; font-weight:bold; transition: 0.3s; }
        .add-btn{ background:var(--primary); color:white; flex:2; }
        .logout-btn{ background:var(--error); color:white; flex:1; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: var(--primary); z-index: 2000; visibility: hidden; }
        #loader.active { visibility: visible; animation: loadingBar 2s infinite; }
        @keyframes loadingBar { 0% { left: -100%; width: 30%; } 100% { left: 100%; width: 0%; } }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 12px 25px; border-radius: 50px; border: 1px solid var(--primary); z-index: 9999; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight: 600; text-align: center; min-width: 200px; }
        .toast.show { display: block; animation: fadeInUp 0.4s; }

        .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:15px; padding:15px; }
        .card{ background:var(--card); border-radius:25px; padding:12px; text-align:center; border:1px solid var(--border); transition: 0.3s; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card img{ width:100%; height:160px; object-fit:cover; border-radius:18px; cursor:pointer; }
        .warranty-tag { background: rgba(46, 160, 67, 0.15); color: var(--primary); font-size: 10px; padding: 4px 10px; border-radius: 8px; display: inline-block; margin-top: 10px; font-weight: bold; }
        .card h4 { margin: 12px 0 5px; font-size: 15px; height: 40px; overflow: hidden; }
        .price-row { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 12px; }
        .price{ color:var(--primary); font-weight:700; font-size: 18px; }
        .old-price { color: #888; text-decoration: line-through; font-size: 13px; }
        .wa-btn{ background:#25d366; color:white; padding:12px; border-radius:12px; text-decoration:none; font-size:13px; font-weight:bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: var(--error); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; display: none; z-index: 10; cursor: pointer; }

        .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:5000; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); padding: 25px; border-radius: 30px; max-width: 90%; width: 360px; text-align: center; border: 1px solid var(--border); }
        .modal img{ width:100%; border-radius:20px; }
    </style>
</head>
<body class="dark-mode">

<div id="loader"></div>
<div id="toast-msg" class="toast"></div>

<header>
    <div class="logo">THE MAX</div>
    <div class="nav-icons">
        <i class="fas fa-adjust icon-btn" onclick="toggleTheme()"></i>
        <div class="icon-btn" onclick="handleAdminAuth()"><i class="fas fa-shield-alt"></i></div>
    </div>
</header>

<div class="cat-wrap" id="cat-filters">
    <button class="cat-btn active" onclick="filterCat('all', this)">‡¶∏‡¶¨ ‡¶™‡¶£‡ßç‡¶Ø</button>
    <button class="cat-btn" onclick="filterCat('watch', this)">‡¶ò‡ßú‡¶ø</button>
    <button class="cat-btn" onclick="filterCat('headphone', this)">‡¶π‡ßá‡¶°‡¶´‡ßã‡¶®</button>
    <button class="cat-btn" onclick="filterCat('gadget', this)">‡¶ó‡ßç‡¶Ø‡¶æ‡¶ú‡ßá‡¶ü</button>
</div>

<div id="admin-panel">
    <h3 style="margin-bottom:15px; color:var(--primary)">‚ûï ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤</h3>
    <input type="text" id="pname" class="admin-input" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
    <input type="number" id="pprice" class="admin-input" placeholder="‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)">
    <input type="number" id="poldprice" class="admin-input" placeholder="‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)">
    <input type="text" id="pimg" class="admin-input" placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (Direct URL)">
    <input type="text" id="pwarranty" class="admin-input" placeholder="‡¶ì‡ßü‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø (‡¶â‡¶¶‡¶æ: 7 Days)">
    <select id="pcat" class="admin-input">
        <option value="watch">‡¶ò‡ßú‡¶ø</option>
        <option value="headphone">‡¶π‡ßá‡¶°‡¶´‡ßã‡¶®</option>
        <option value="gadget">‡¶ó‡ßç‡¶Ø‡¶æ‡¶ú‡ßá‡¶ü</option>
    </select>
    <div class="btn-group">
        <button class="add-btn" onclick="addProductToFirebase()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="logout-btn" onclick="adminLogout()">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
    </div>
</div>

<div class="grid" id="product-list"></div>

<div class="modal" id="zoomModal">
    <div class="modal-content">
        <img id="zoomImg">
        <h3 id="zoomTitle" style="margin-top:15px"></h3>
        <p id="zoomWarranty" style="color:var(--primary); font-size: 14px; margin-top:5px;"></p>
        <button class="wa-btn" id="modalOrderBtn" style="margin-top:15px; width:100%">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="closeModal()" style="margin-top:10px; background:transparent; color:var(--text)">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAoZzONz8I2W70_b4oR_7cGxbQCmDaipWg",
    authDomain: "shop-h-215df.firebaseapp.com",
    projectId: "shop-h-215df",
    storageBucket: "shop-h-215df.firebasestorage.app",
    messagingSenderId: "60483176788",
    appId: "1:60483176788:web:cdadf8c99fccb3d20620c1",
    measurementId: "G-CD5JVG7225"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let isAdmin = false;
  let allProducts = [];
  let currentFilter = 'all';
  let unsubscribeListener = null;

  // üîπ ‡ßß. XSS Protection: HTML ‡¶∏‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶ü‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
  function sanitize(str) {
    const temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
  }

  // üîπ ‡ß®. ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ (Fixed: Error handling & null timestamp metadata)
  function startListening() {
    if (unsubscribeListener) unsubscribeListener();
    
    // includeMetadataChanges: true ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™ ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶ï‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá
    unsubscribeListener = db.collection('products').orderBy('createdAt', 'desc').onSnapshot({ includeMetadataChanges: true }, snapshot => {
      allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      applyFilter();
    }, error => {
      console.error("Firestore Error:", error);
      showToast("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá!", "error");
    });
  }

  // üîπ ‡ß©. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ö‡ßá‡¶ï (Fixed: Restricted Email)
  async function handleAdminAuth() {
    if(isAdmin) return;
    const email = prompt("Admin Email:");
    const pass = prompt("Password:");
    if(email && pass) {
        showLoader(true);
        try {
            await auth.signInWithEmailAndPassword(email, pass);
        } catch(e) { 
            showToast("‡¶≤‡¶ó‡¶á‡¶® ‡¶≠‡ßÅ‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "error"); 
            showLoader(false);
        }
    }
  }

  auth.onAuthStateChanged(user => {
    isAdmin = user && user.email === "nayemhossen20005@gmail.com";
    document.getElementById("admin-panel").style.display = isAdmin ? "block" : "none";
    if (user && !isAdmin) {
        showToast("‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!", "error");
        auth.signOut();
    } else if (isAdmin) {
        showToast("‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®!", "success");
    }
    startListening();
    showLoader(false);
  });

  function adminLogout() {
    auth.signOut();
    showToast("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶∏‡¶´‡¶≤!", "success");
  }

  // üîπ ‡ß™. ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (Fixed: Validation & Number conversion)
  async function addProductToFirebase() {
    if(!isAdmin) return showToast("‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");

    const p = {
        name: sanitize(document.getElementById("pname").value),
        price: parseFloat(document.getElementById("pprice").value),
        oldPrice: parseFloat(document.getElementById("poldprice").value) || null,
        img: sanitize(document.getElementById("pimg").value),
        warranty: sanitize(document.getElementById("pwarranty").value),
        cat: document.getElementById("pcat").value,
        createdAt: firebase.firestore.FieldValue.serverTimestamp() // Server-side sorting
    };

    // Improved Validation (isNaN check for price)
    if(!p.name || isNaN(p.price) || !p.img) return showToast("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶®!", "error");

    showLoader(true);
    try {
        await db.collection('products').add(p);
        showToast("‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        clearForm();
    } catch(e) { 
        showToast("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "error"); 
    } finally { showLoader(false); }
  }

  async function deleteProduct(id) {
    if(!isAdmin) return showToast("‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á!", "error");
    if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        showLoader(true);
        try {
            await db.collection('products').doc(id).delete();
            showToast("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!", "success");
        } finally { showLoader(false); }
    }
  }

  function filterCat(cat, btn) {
    currentFilter = cat;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    applyFilter();
  }

  function applyFilter() {
    const data = currentFilter === 'all' ? allProducts : allProducts.filter(p => p.cat === currentFilter);
    renderProducts(data);
  }

  function renderProducts(data) {
    const list = document.getElementById("product-list");
    if(!data.length) {
        list.innerHTML = `<div style="grid-column: 1/3; text-align:center; padding:50px; opacity:0.5;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
        return;
    }
    
    // Using sanitize logic while rendering to prevent XSS
    list.innerHTML = data.map(p => `
      <div class="card">
        <button class="delete-btn" style="display: ${isAdmin ? 'block':'none'}" onclick="deleteProduct('${p.id}')">√ó</button>
        <img src="${p.img}" onclick="zoom('${p.img}','${sanitize(p.name)}', '${sanitize(p.warranty)}')" alt="${sanitize(p.name)}">
        <span class="warranty-tag">${sanitize(p.warranty) || 'No Warranty'}</span>
        <h4>${sanitize(p.name)}</h4>
        <div class="price-row">
          <span class="price">‡ß≥${p.price}</span>
          ${p.oldPrice ? `<span class="old-price">‡ß≥${p.oldPrice}</span>` : ''}
        </div>
        <a class="wa-btn" href="https://wa.me/8801788350024?text=‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶á: ${sanitize(p.name)}">
          <i class="fab fa-whatsapp"></i> ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        </a>
      </div>`).join('');
  }

  function toggleTheme() { document.body.classList.toggle('light-mode'); }
  function showLoader(show) { document.getElementById("loader").classList.toggle('active', show); }
  
  function showToast(msg, type) {
    const t = document.getElementById("toast-msg");
    t.innerText = msg;
    t.style.borderColor = type === 'success' ? 'var(--success)' : 'var(--error)';
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
  }

  function clearForm() {
    ['pname','pprice','poldprice','pimg','pwarranty'].forEach(id => document.getElementById(id).value = '');
  }

  function zoom(img, title, warranty) {
    document.getElementById("zoomImg").src = img;
    document.getElementById("zoomTitle").innerText = title;
    document.getElementById("zoomWarranty").innerText = warranty || "No Warranty";
    document.getElementById("modalOrderBtn").onclick = () => window.open(`https://wa.me/8801788350024?text=‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á: ${title}`);
    document.getElementById("zoomModal").style.display = "flex";
  }

  function closeModal() { document.getElementById("zoomModal").style.display = "none"; }
</script>
</body>
</html>
