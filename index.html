<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE MAX | v6.1 Masterpiece</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary:#2ea043; --bg:#0b1118; --card:#1c2128; --text:#ffffff; --border:#30363d; --accent:#58a6ff; }
        .light-mode { --bg:#f0f2f5; --card:#ffffff; --text:#1c1e21; --border:#ddd; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { overscroll-behavior-y: contain; background: var(--bg); color: var(--text); font-family: 'Hind Siliguri', sans-serif; transition: background 0.3s, color 0.3s; margin: 0; line-height: 1.6; }

        /* ১ ও ২: অ্যাডভান্সড পিন্চ ও প্যান জুম (Fix 1 & 2) */
        #smartZoom { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100000; justify-content:center; align-items:center; overflow: hidden; touch-action: none; }
        #zoomContainer { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #smartZoom img { max-width:100%; max-height:100%; object-fit:contain; transform-origin: center; will-change: transform; transition: transform 0.1s ease-out; }
        .close-zoom { position:fixed; top:25px; right:25px; font-size:28px; color:white; cursor:pointer; z-index:100001; background: rgba(0,0,0,0.6); width: 44px; height: 44px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid rgba(255,255,255,0.2); }

        header { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; border-bottom:2px solid var(--primary); position:sticky; top:0; background:var(--bg); z-index:1000; }
        .logo { font-size:22px; font-weight:700; color:var(--primary); text-decoration: none; }

        .user-bar { display:flex; align-items:center; gap:10px; padding:10px 15px; background:rgba(46,160,67,0.08); font-size: 14px; border-bottom: 1px solid var(--border); }
        .user-img { width:30px; height:30px; border-radius:50%; border: 1.5px solid var(--primary); }

        .search-area { padding: 15px; }
        .search-bar { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.5px solid var(--border); background: var(--card); color: var(--text); font-size: 15px; transition: border-color 0.3s; }
        .search-bar:focus { border-color: var(--primary); }

        .cat-scroll { display: flex; gap: 10px; padding: 0 15px 15px; overflow-x: auto; scrollbar-width: none; }
        .cat-chip { background: var(--card); border: 1px solid var(--border); padding: 8px 20px; border-radius: 25px; cursor: pointer; white-space: nowrap; font-size: 14px; transition: 0.2s; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
        .cat-chip:hover:not(.active) { border-color: var(--primary); }

        .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; padding:10px 15px; }
        .card { background:var(--card); border-radius:15px; padding:12px; border:1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.2s; position: relative; }
        .card img { width:100%; height:150px; object-fit:cover; border-radius:12px; cursor: pointer; margin-bottom: 10px; background: #222; }
        .card h4 { font-size: 14px; margin: 0 0 8px; height: 42px; overflow: hidden; font-weight: 600; }
        
        .price { color:var(--primary); font-weight:700; font-size: 17px; margin-bottom: 10px; display: block; }
        .buy-btn { background:var(--primary); color:white; padding:12px; border-radius:10px; width: 100%; border: none; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.3s; position: relative; overflow: hidden; }
        .buy-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:3000; padding:15px; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(0); transition: transform 0.3s ease; }
        .in { width:100%; padding:14px; margin-bottom:12px; border-radius:10px; border:1px solid var(--border); background: var(--card); color: var(--text); font-size: 15px; }
        
        .pay-logos { display:flex; justify-content:center; gap:20px; margin:15px 0; }
        .pay-logos img { width:55px; cursor:pointer; border-radius:10px; border: 2.5px solid transparent; transition: 0.3s; padding: 3px; }
        .pay-logos img.active { border-color: var(--primary); background: rgba(46,160,67,0.15); transform: translateY(-3px); }

        #success-toast { visibility: hidden; min-width: 250px; background: var(--primary); color: white; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 10000; left: 50%; top: -100px; transform: translateX(-50%); transition: top 0.5s ease; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        #success-toast.show { visibility: visible; top: 30px; }

        @media (max-width: 330px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="dark-mode">

<div id="success-toast" role="alert" aria-live="assertive">অর্ডার সফল হয়েছে!</div>

<div id="smartZoom" aria-hidden="true">
    <span class="close-zoom" onclick="StoreApp.closeZoom()" aria-label="Close image zoom" tabindex="0" onkeypress="if(event.key==='Enter') StoreApp.closeZoom()">&times;</span>
    <div id="zoomContainer">
        <img id="zImg" src="" alt="পণ্য বিস্তারিত জুম">
    </div>
</div>

<header>
    <a href="#" class="logo">THE MAX</a>
    <div class="nav-icons" style="display: flex; gap: 18px;">
        <i class="fas fa-moon" style="cursor:pointer; font-size: 20px;" onclick="StoreApp.toggleTheme()" id="tIcon" aria-label="Toggle dark mode" role="button" tabindex="0"></i>
        <i class="fas fa-user-shield" style="cursor:pointer; font-size: 20px;" onclick="StoreApp.checkAdmin()" aria-label="Open admin panel" role="button" tabindex="0"></i>
    </div>
</header>

<div class="user-bar" id="userBar"></div>

<div class="search-area">
    <input type="text" id="sInp" class="search-bar" placeholder="পণ্য খুঁজুন (e.g. T500 Ultra)..." oninput="StoreApp.render()" aria-label="Search products">
</div>

<div class="cat-scroll" id="cat-list" role="tablist"></div>

<div id="admin-panel" style="display:none; padding:20px; background:var(--card); border:2px solid var(--primary); margin:15px; border-radius:15px;">
    <h3 style="margin-top:0">নতুন পণ্য যুক্ত করুন</h3>
    <input type="text" id="pName" class="in" placeholder="পণ্যের নাম *">
    <input type="number" id="pPrice" class="in" placeholder="দাম (অবশ্যই ০-এর বেশি) *">
    <input type="text" id="pImg" class="in" placeholder="ইমেজ লিঙ্ক (URL) *">
    <input type="text" id="pCatInput" class="in" placeholder="ক্যাটাগরি (e.g. Watch)">
    <button class="buy-btn" id="upBtn" onclick="StoreApp.uploadProduct()">পণ্য সেভ করুন</button>
    <button class="buy-btn" style="background:#444; margin-top:10px" onclick="StoreApp.closeAdmin()">বাতিল</button>
</div>

<div class="grid" id="main-grid"></div>

<div class="modal" id="pModal" aria-modal="true" role="dialog" onkeydown="if(event.key==='Escape') StoreApp.closeM()">
    <div class="modal-content" id="modalContent">
        <h3 style="margin-top:0">অর্ডার সম্পন্ন করুন</h3>
        <div id="mBody" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:15px; font-size:14px;"></div>
        
        <p style="font-size:13px; color:var(--primary); margin-bottom: 8px;">পেমেন্ট মাধ্যম সিলেক্ট করুন:</p>
        <div class="pay-logos">
            <img src="https://img.icons8.com/color/48/bkash.png" id="bk" onclick="StoreApp.selectPay('Bkash')" alt="বিকাশ">
            <img src="https://img.icons8.com/color/48/nagad.png" id="ng" onclick="StoreApp.selectPay('Nagad')" alt="নগদ">
        </div>

        <input type="text" id="oName" class="in" placeholder="আপনার নাম *">
        <input type="text" id="oPhone" class="in" placeholder="মোবাইল নম্বর (১১ ডিজিট) *">
        <input type="text" id="oTrx" class="in" placeholder="Transaction ID (TrxID) *">
        
        <button class="buy-btn" id="confirmBtn" onclick="StoreApp.placeOrder()">অর্ডার কনফার্ম করুন</button>
        <button class="buy-btn" style="background:#444; margin-top:10px" onclick="StoreApp.closeM()">বন্ধ করুন</button>
    </div>
</div>

<footer style="padding: 30px; text-align: center; border-top: 1px solid var(--border); margin-top: 20px;">
    <div class="socials" style="display: flex; justify-content: center; gap: 25px; margin-bottom: 12px;">
        <a href="https://wa.me/8801788350024" target="_blank" style="color:var(--primary); font-size: 26px;" aria-label="WhatsApp Us"><i class="fab fa-whatsapp"></i></a>
        <a href="https://www.facebook.com/share/17ZHe2aFT1/" target="_blank" style="color:var(--primary); font-size: 26px;" aria-label="Follow us on Facebook"><i class="fab fa-facebook"></i></a>
    </div>
    <p style="font-size: 13px; opacity: 0.7;">© 2026 THE MAX - v6.1 Masterpiece | Developed by Nayem Hossen</p>
</footer>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
    const StoreApp = (function() {
        const WA_NUM = "8801788350024";
        const fbConfig = {
            apiKey: "AIzaSyAoZzONz8I2W70_b4oR_7cGxbQCmDaipWg",
            authDomain: "shop-h-215df.firebaseapp.com",
            projectId: "shop-h-215df",
            appId: "1:60483176788:web:cdadf8c99fccb3d20620c1"
        };
        firebase.initializeApp(fbConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        // State Management (Fix 5: Race conditions)
        let state = {
            prods: [],
            curCat: localStorage.getItem('maxCat') || 'all',
            user: null,
            selectedP: null,
            payMethod: '',
            isLoading: false,
            zoom: { scale: 1, x: 0, y: 0, dist: 0, lastX: 0, lastY: 0 }
        };

        // ৪: উন্নত স্যানিটাইজার ও ভ্যালিডেশন (Fix 4)
        const sanitize = (str, len = 50) => str.replace(/[^\w\s\u0980-\u09FF-]/gi, '').substring(0, len).trim();

        const toast = (msg) => {
            const el = document.getElementById("success-toast");
            el.innerText = msg;
            el.classList.add("show");
            setTimeout(() => el.classList.remove("show"), 3000);
        };

        // ১: মাল্টি-টাচ পিন্চ জুম হ্যান্ডলিং (Fix 1: GestureEvent Logic)
        const initZoom = () => {
            const container = document.getElementById('zoomContainer');
            const img = document.getElementById('zImg');

            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    state.zoom.dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                } else if (e.touches.length === 1) {
                    state.zoom.lastX = e.touches[0].pageX - state.zoom.x;
                    state.zoom.lastY = e.touches[0].pageY - state.zoom.y;
                }
            });

            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    let newDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    let zoomDelta = newDist / state.zoom.dist;
                    state.zoom.scale = Math.min(Math.max(1, state.zoom.scale * zoomDelta), 4);
                    state.zoom.dist = newDist;
                } else if (e.touches.length === 1 && state.zoom.scale > 1) {
                    state.zoom.x = e.touches[0].pageX - state.zoom.lastX;
                    state.zoom.y = e.touches[0].pageY - state.zoom.lastY;
                }
                img.style.transform = `translate(${state.zoom.x}px, ${state.zoom.y}px) scale(${state.zoom.scale})`;
            }, { passive: false });
        };

        return {
            init: () => {
                initZoom();
                const theme = localStorage.getItem('maxTheme') || 'dark-mode';
                document.body.className = theme;
                document.getElementById('tIcon').className = theme === 'light-mode' ? 'fas fa-sun' : 'fas fa-moon';

                auth.onAuthStateChanged(u => {
                    state.user = u;
                    const bar = document.getElementById('userBar');
                    if(u) {
                        bar.innerHTML = `<img src="${u.photoURL}" class="user-img" alt="Profile"> <span>${u.displayName}</span> <button onclick="StoreApp.logout()" style="background:none; border:none; color:#ff4d4d; cursor:pointer; font-size:12px; margin-left:10px;">Logout</button>`;
                        document.getElementById('oName').value = u.displayName;
                    } else {
                        bar.innerHTML = `<button class="buy-btn" style="width:auto; padding:5px 15px; font-size:12px;" onclick="StoreApp.login()">Google দিয়ে লগইন</button>`;
                    }
                    db.collection('products').orderBy('createdAt', 'desc').onSnapshot(s => {
                        state.prods = s.docs.map(d => ({id: d.id, ...d.data()}));
                        StoreApp.render();
                    });
                });
            },

            login: () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()),
            logout: () => auth.signOut(),

            openZoom: (url) => {
                state.zoom = { scale: 1, x: 0, y: 0, dist: 0, lastX: 0, lastY: 0 };
                document.getElementById('zImg').src = url;
                document.getElementById('zImg').style.transform = `scale(1)`;
                document.getElementById('smartZoom').style.display = 'flex';
                document.getElementById('smartZoom').setAttribute('aria-hidden', 'false');
            },
            closeZoom: () => {
                document.getElementById('smartZoom').style.display = 'none';
                document.getElementById('smartZoom').setAttribute('aria-hidden', 'true');
            },

            checkAdmin: () => {
                if(state.user && state.user.email === "nayemhossen20005@gmail.com") document.getElementById('admin-panel').style.display = 'block';
                else alert("আপনি অ্যাডমিন নন!");
            },
            closeAdmin: () => document.getElementById('admin-panel').style.display = 'none',

            uploadProduct: async () => {
                if(state.isLoading) return;
                const name = document.getElementById('pName').value.trim();
                const price = parseFloat(document.getElementById('pPrice').value);
                const img = document.getElementById('pImg').value.trim();
                const cat = sanitize(document.getElementById('pCatInput').value) || 'Gadget';

                if(!name || isNaN(price) || price <= 0 || !img) return alert("তথ্য সঠিক দিন!");

                state.isLoading = true;
                const btn = document.getElementById('upBtn');
                btn.disabled = true; btn.innerText = "সেভ হচ্ছে...";

                await db.collection('products').add({ name, price, img, cat, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                toast("পণ্যটি যুক্ত হয়েছে!");
                state.isLoading = false; btn.disabled = false; btn.innerText = "পণ্য সেভ করুন";
                StoreApp.closeAdmin();
            },

            selectPay: (method) => {
                state.payMethod = method;
                document.getElementById('bk').className = method === 'Bkash' ? 'active' : '';
                document.getElementById('ng').className = method === 'Nagad' ? 'active' : '';
            },

            openM: (id) => {
                state.selectedP = state.prods.find(p => p.id === id);
                document.getElementById('mBody').innerHTML = `<strong>পণ্য:</strong> ${state.selectedP.name} <br> <strong>মূল্য:</strong> ৳${state.selectedP.price}`;
                document.getElementById('pModal').style.display = 'flex';
                document.getElementById('modalContent').style.transform = 'translateY(0)';
            },

            closeM: () => {
                document.getElementById('modalContent').style.transform = 'translateY(20px)';
                setTimeout(() => {
                    document.getElementById('pModal').style.display = 'none';
                    state.payMethod = ''; // ২ ও ৩: রিসেট পে মেথড (Fix 2 & 3)
                    document.getElementById('bk').className = '';
                    document.getElementById('ng').className = '';
                }, 200);
            },

            placeOrder: async () => {
                if(state.isLoading) return; // ৭: ডাবল ক্লিক সেফটি (Fix 7)
                const name = document.getElementById('oName').value.trim();
                const phone = document.getElementById('oPhone').value.trim();
                const trx = sanitize(document.getElementById('oTrx').value, 20);

                if(name.length < 3 || !/^01[3-9]\d{8}$/.test(phone) || !state.payMethod || !trx) return alert("অনুগ্রহ করে সঠিক তথ্য দিন!");

                state.isLoading = true;
                const btn = document.getElementById('confirmBtn');
                btn.disabled = true; btn.innerText = "অর্ডার হচ্ছে...";

                try {
                    await db.collection('orders').add({
                        item: state.selectedP.name, customer: name, phone, 
                        method: state.payMethod, trx, userId: state.user ? state.user.uid : 'Guest',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    toast("ধন্যবাদ! আপনার অর্ডার গ্রহণ করা হয়েছে।");
                    window.open(`https://wa.me/${WA_NUM}?text=নতুন অর্ডার!%0Aপণ্য: ${state.selectedP.name}%0ATrxID: ${trx}`, '_blank');
                    StoreApp.closeM();
                } catch(e) { alert("দুঃখিত, পুনরায় চেষ্টা করুন।"); }
                state.isLoading = false; btn.disabled = false; btn.innerText = "অর্ডার কনফার্ম করুন";
            },

            render: () => {
                const uniqueCats = ['all', ...new Set(state.prods.map(p => p.cat))];
                document.getElementById('cat-list').innerHTML = uniqueCats.map(c => `<div class="cat-chip ${state.curCat === c ? 'active' : ''}" onclick="StoreApp.setCat('${c}')" role="tab">${c}</div>`).join('');
                
                const term = document.getElementById('sInp').value.toLowerCase();
                const filtered = state.prods.filter(p => (state.curCat === 'all' || p.cat === state.curCat) && p.name.toLowerCase().includes(term));
                
                document.getElementById('main-grid').innerHTML = filtered.map(p => `
                    <div class="card">
                        <img src="${p.img}" onclick="StoreApp.openZoom('${p.img}')" alt="${p.name}" loading="lazy"> <h4>${p.name}</h4>
                        <span class="price">৳${p.price}</span>
                        <button class="buy-btn" onclick="StoreApp.openM('${p.id}')">অর্ডার দিন</button>
                    </div>`).join('');
            },

            setCat: (c) => { state.curCat = c; localStorage.setItem('maxCat', c); StoreApp.render(); },
            toggleTheme: () => {
                const newT = document.body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';
                localStorage.setItem('maxTheme', newT);
                document.body.className = newT;
                document.getElementById('tIcon').className = newT === 'light-mode' ? 'fas fa-sun' : 'fas fa-moon';
            }
        };
    })();

    StoreApp.init();
</script>
</body>
</html>
